name: Docs Sync

on:
  push:
    branches: [ main ]
    paths:
      - "docs/**"

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Check out docs source
        uses: actions/checkout@v4
        with:
          path: docs-source

      - name: Set short SHA
        id: vars
        shell: bash
        run: |
          echo "short_sha=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Check out fortunetell-backend
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/fortunetell-backend
          token: ${{ secrets.DOCS_SYNC_TOKEN }}
          path: backend

      - name: Sync docs to fortunetell-backend
        shell: bash
        run: |
          cd backend
          rm -rf docs
          mkdir -p docs
          cp -R ../docs-source/docs/. docs/

          git config user.name "docs-sync-bot"
          git config user.email "docs-sync-bot@users.noreply.github.com"

          git add docs
          if git diff --cached --quiet; then
            echo "No docs changes for fortunetell-backend; skipping commit."
            exit 0
          fi

          git commit -m "chore(docs): sync from fortunetell-docs@${{ steps.vars.outputs.short_sha }}"
          git push origin main

      - name: Check out fortunetell-frontend
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/fortunetell-frontend
          token: ${{ secrets.DOCS_SYNC_TOKEN }}
          path: frontend

      - name: Sync docs to fortunetell-frontend
        shell: bash
        run: |
          cd frontend
          rm -rf docs
          mkdir -p docs
          cp -R ../docs-source/docs/. docs/

          git config user.name "docs-sync-bot"
          git config user.email "docs-sync-bot@users.noreply.github.com"

          git add docs
          if git diff --cached --quiet; then
            echo "No docs changes for fortunetell-frontend; skipping commit."
            exit 0
          fi

          git commit -m "chore(docs): sync from fortunetell-docs@${{ steps.vars.outputs.short_sha }}"
          git push origin main

      - name: Check out fortunetell-site
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/fortunetell-site
          token: ${{ secrets.DOCS_SYNC_TOKEN }}
          path: site

      - name: Sync docs to fortunetell-site
        shell: bash
        run: |
          cd site
          rm -rf docs
          mkdir -p docs
          cp -R ../docs-source/docs/. docs/

          git config user.name "docs-sync-bot"
          git config user.email "docs-sync-bot@users.noreply.github.com"

          git add docs
          if git diff --cached --quiet; then
            echo "No docs changes for fortunetell-site; skipping commit."
            exit 0
          fi

          git commit -m "chore(docs): sync from fortunetell-docs@${{ steps.vars.outputs.short_sha }}"
          git push origin main

      - name: Check out simple-budget-site
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/simple-budget-site
          token: ${{ secrets.DOCS_SYNC_TOKEN }}
          path: simple-budget-site

      - name: Sync docs to simple-budget-site
        shell: bash
        run: |
          cd simple-budget-site
          rm -rf docs
          mkdir -p docs
          cp -R ../docs-source/docs/. docs/

          git config user.name "docs-sync-bot"
          git config user.email "docs-sync-bot@users.noreply.github.com"

          git add docs
          if git diff --cached --quiet; then
            echo "No docs changes for simple-budget-site; skipping commit."
            exit 0
          fi

          git commit -m "chore(docs): sync from fortunetell-docs@${{ steps.vars.outputs.short_sha }}"
          git push origin main
